# project/BUILD.bazel

load("@nRF5//rules:nrf.bzl", "nrf_binary")

package(default_visibility = ["//visibility:public"])

board_sources = select({
    "@nRF5//boards:pca10056": [
        "@nrf_sdk//:modules/nrfx/mdk/gcc_startup_nrf52840.S",
        "@nrf_sdk//:modules/nrfx/mdk/system_nrf52840.c",
    ],
    "//conditions:default": [],
})

board_defines = select({
    "@nRF5//boards:pca10056": [
        "BOARD_PCA10056",
        "NRF52840_XXAA",
    ],
    "//conditions:default": [],
})

nrf_binary(
    name = "usb_audio",
    srcs = board_sources + [
        "source/main.c",
        "config/sdk_config.h",
        "@nrf_sdk//:components/libraries/log/src/nrf_log_backend_rtt.c",
        "@nrf_sdk//:components/libraries/log/src/nrf_log_backend_serial.c",
        "@nrf_sdk//:components/libraries/log/src/nrf_log_backend_uart.c",
        "@nrf_sdk//:components/libraries/log/src/nrf_log_default_backends.c",
        "@nrf_sdk//:components/libraries/log/src/nrf_log_frontend.c",
        "@nrf_sdk//:components/libraries/log/src/nrf_log_str_formatter.c",
        "@nrf_sdk//:components/boards/boards.c",
        "@nrf_sdk//:components/libraries/button/app_button.c",
        "@nrf_sdk//:components/libraries/util/app_error.c",
        "@nrf_sdk//:components/libraries/util/app_error_handler_gcc.c",
        "@nrf_sdk//:components/libraries/util/app_error_weak.c",
        "@nrf_sdk//:components/libraries/fifo/app_fifo.c",
        "@nrf_sdk//:components/libraries/scheduler/app_scheduler.c",
        "@nrf_sdk//:components/libraries/timer/app_timer2.c",
        "@nrf_sdk//:components/libraries/uart/app_uart_fifo.c",
        "@nrf_sdk//:components/libraries/usbd/app_usbd.c",
        "@nrf_sdk//:components/libraries/usbd/class/audio/app_usbd_audio.c",
        "@nrf_sdk//:components/libraries/usbd/app_usbd_core.c",
        "@nrf_sdk//:components/libraries/usbd/app_usbd_string_desc.c",
        "@nrf_sdk//:components/libraries/util/app_util_platform.c",
        "@nrf_sdk//:components/libraries/timer/drv_rtc.c",
        "@nrf_sdk//:components/libraries/hardfault/nrf52/handler/hardfault_handler_gcc.c",
        "@nrf_sdk//:components/libraries/hardfault/hardfault_implementation.c",
        "@nrf_sdk//:components/libraries/util/nrf_assert.c",
        "@nrf_sdk//:components/libraries/atomic_fifo/nrf_atfifo.c",
        "@nrf_sdk//:components/libraries/atomic/nrf_atomic.c",
        "@nrf_sdk//:components/libraries/balloc/nrf_balloc.c",
        "@nrf_sdk//:external/fprintf/nrf_fprintf.c",
        "@nrf_sdk//:external/fprintf/nrf_fprintf_format.c",
        "@nrf_sdk//:components/libraries/memobj/nrf_memobj.c",
        "@nrf_sdk//:components/libraries/ringbuf/nrf_ringbuf.c",
        "@nrf_sdk//:components/libraries/sortlist/nrf_sortlist.c",
        "@nrf_sdk//:components/libraries/strerror/nrf_strerror.c",
        "@nrf_sdk//:integration/nrfx/legacy/nrf_drv_clock.c",
        "@nrf_sdk//:integration/nrfx/legacy/nrf_drv_power.c",
        "@nrf_sdk//:integration/nrfx/legacy/nrf_drv_uart.c",
        "@nrf_sdk//:components/drivers_nrf/nrf_soc_nosd/nrf_nvic.c",
        "@nrf_sdk//:components/drivers_nrf/nrf_soc_nosd/nrf_soc.c",
        "@nrf_sdk//:modules/nrfx/soc/nrfx_atomic.c",
        "@nrf_sdk//:modules/nrfx/drivers/src/nrfx_clock.c",
        "@nrf_sdk//:modules/nrfx/drivers/src/nrfx_gpiote.c",
        "@nrf_sdk//:modules/nrfx/drivers/src/nrfx_power.c",
        "@nrf_sdk//:modules/nrfx/drivers/src/prs/nrfx_prs.c",
        "@nrf_sdk//:modules/nrfx/drivers/src/nrfx_systick.c",
        "@nrf_sdk//:modules/nrfx/drivers/src/nrfx_uart.c",
        "@nrf_sdk//:modules/nrfx/drivers/src/nrfx_uarte.c",
        "@nrf_sdk//:modules/nrfx/drivers/src/nrfx_usbd.c",
        "@nrf_sdk//:components/libraries/bsp/bsp.c",
        "@nrf_sdk//:external/segger_rtt/SEGGER_RTT.c",
        "@nrf_sdk//:external/segger_rtt/SEGGER_RTT_Syscalls_GCC.c",
        "@nrf_sdk//:external/segger_rtt/SEGGER_RTT_printf.c",
        "@nrf_sdk//:external/utf_converter/utf.c",
    ],
    copts = [
        "-O3",
        "-g3",
        "-mcpu=cortex-m4",
        "-mthumb -mabi=aapcs",
        "-Wall -Werror",
        "-mfloat-abi=hard -mfpu=fpv4-sp-d16",
        "-ffunction-sections -fdata-sections -fno-strict-aliasing",
        "-fno-builtin -fshort-enums",
    ],
    includes = ["config"],
    linker = ":linker.ld",
    linkopts = [
        "-O3 -g3",
        "-mthumb -mabi=aapcs",
        "-mcpu=cortex-m4",
        "-mfloat-abi=hard -mfpu=fpv4-sp-d16",
        "-Wl,--gc-sections",
        "--specs=nano.specs",
        "-lc -lnosys -lm",
    ],
    local_defines = board_defines + [
        "APP_TIMER_V2",
        "APP_TIMER_V2_RTC1_ENABLED",
        "CONFIG_GPIO_AS_PINRESET",
        "FLOAT_ABI_HARD",
        "__HEAP_SIZE=8192",
        "__STACK_SIZE=8192",
    ],
    target_compatible_with = [
        "@nRF5//boards:pca10056",
        "@platforms//cpu:arm",
        "@platforms//os:none",
    ],
)
